---
title: "Lock"
description: "Lock에 대해서 설명합니다."
category: "DB"
cover: images/thumbnail/db.png
coverAlt: "about Lock"
datePublished: "2024-12-25"
dateModified: "2024-12-25"
tags:
  - DB
  - Lock
---
### 정의

- 트랜잭션이 데이터를 수정하거나 조회하는 동안, **다른 트랜잭션이 해당 데이터에 접근하지 못하도록 막는 메커니즘**.
- 데이터의 무결성을 보장하기 위해 사용됨.

### Lock 동작 방식

1. **Lock 획득**:
    - 트랜잭션 시작 시 데이터에 대한 Lock을 획득.
2. **Lock 유지**:
    - `Commit` 또는 `Rollback` 시까지 Lock이 유지됨.
3. **Lock 반환**:
    - 트랜잭션이 종료되면 Lock이 반환되고, 다른 트랜잭션에서 해당 데이터에 접근 가능.

---

### Lock의 대기 시간

- 트랜잭션이 Lock을 획득하려고 할 때, 해당 데이터가 이미 다른 트랜잭션에 의해 Lock된 경우 대기 상태가 발생.
- 대기 시간을 초과하면 **Lock Timeout** 오류가 발생하며, 이는 설정을 통해 조정 가능.
    - 예: MySQL의 `innodb_lock_wait_timeout`.

---

### Lock의 종류

1. **공유 락(Shared Lock, S-Lock)**
    - 데이터에 대해 **읽기 작업만 허용**하며, 다른 트랜잭션도 읽기 작업 가능.
    - 쓰기 작업은 불가능.
    - 예: `SELECT ... LOCK IN SHARE MODE`.
2. **배타 락(Exclusive Lock, X-Lock)**
    - 데이터에 대해 **쓰기 작업**을 수행할 수 있는 락.
    - 다른 트랜잭션은 읽기와 쓰기 모두 불가능.
    - 예: `SELECT ... FOR UPDATE`.

---

### 조회 시 Lock 획득

- **조회 시 Lock이 필요한 경우**:
    - 트랜잭션이 데이터 조회 후, 해당 데이터가 **트랜잭션 종료 시점까지 변경되지 않도록 보장**해야 할 때.
    - 예: `SELECT ... FOR UPDATE`
        - 데이터를 조회하면서 **Exclusive Lock(배타 락)**을 획득하여 다른 트랜잭션이 데이터를 수정하지 못하도록 함.

### 특징

- Lock을 획득한 트랜잭션이 `Commit` 또는 `Rollback`되기 전까지, 다른 트랜잭션에서 해당 데이터의 수정이 불가능.
- 조회 시에도 Lock을 획득할 수 있음으로 **강력한 데이터 정합성 보장**이 가능.

### 예시: `SELECT ... FOR UPDATE`

- **의미**: 데이터 조회 시 배타 락을 획득하여, 다른 트랜잭션에서 데이터를 수정하지 못하게 함.
- **동작**:
    - 다른 세션에서 데이터를 조회할 경우, 이전에 **Commit된 데이터**만 조회 가능.
    - 트랜잭션 종료 시, 락이 반환되면 다른 트랜잭션에서 데이터 수정 가능.

---

### Lock의 필요성과 한계

### 필요성

- 트랜잭션이 실행 중인 동안 **데이터 정합성**을 유지하기 위해 필수적.
- 데이터베이스의 **동시성 문제(Dirty Read, Non-Repeatable Read, Phantom Read)**를 방지.

### 한계

1. **Deadlock**:
    - 두 개 이상의 트랜잭션이 서로의 Lock을 기다리며 교착 상태에 빠지는 문제.
    - DBMS에서 Deadlock 감지 및 해결 메커니즘을 제공.
2. **Lock 대기 시간**:
    - Lock이 오래 유지되면 다른 트랜잭션이 대기 상태에 빠질 수 있어, 시스템 성능 저하 가능.
3. **적절한 설정 필요**:
    - 지나치게 강한 Lock 설정은 동시성을 제한하여 성능 문제를 야기.
    - 지나치게 약한 Lock 설정은 데이터 정합성을 저해할 수 있음.

---

### 요약

| **항목** | **설명** |
| --- | --- |
| **Lock 획득 시점** | 트랜잭션 시작과 동시에 데이터를 수정하거나 필요한 경우 조회 시에도 Lock 획득. |
| **Lock 반환 시점** | 트랜잭션이 `Commit` 또는 `Rollback`될 때 Lock 해제. |
| **조회 시 Lock** | `SELECT ... FOR UPDATE`로 데이터 조회 중에도 배타 락을 획득하여 다른 트랜잭션의 데이터 수정을 방지. |
| **Lock 대기 시간** | 데이터가 이미 Lock 상태라면 대기, 대기 시간이 초과하면 Timeout 발생. |
| **Lock의 한계** | Deadlock, 성능 저하, 적절한 Lock 설정 필요. |